# 运行consul
```
consul agent -dev
```

# 运行Prometheus和Thanos（需要三个独立的命令窗口）

## 窗口1：运行Prometheus

```
# 进入Prometheus目录并启动服务
c: && cd C:\prometheus\prometheus-3.4.0-rc.0.windows-amd64 && prometheus.exe --config.file=prometheus.yml
```

## 窗口3：运行Thanos Query

```
# 进入thanos目录并cd启动query服务，连接到本地sidecar
c: &&  C:\thanos\thanos-0.38.0.windows-amd64 && thanos.exe query --endpoint=127.0.0.1:10901 --http-address=0.0.0.0:10903 --grpc-address=0.0.0.0:10911
```

# 服务访问地址
- Prometheus UI: http://localhost:9090
- Thanos Sidecar: http://localhost:10902
- Thanos Query UI: http://localhost:10903

# 注意事项
1. 请按顺序启动服务：先启动 Prometheus，再启动 Sidecar，最后启动 Query
2. 启动前请确保相关进程已关闭：
   ```
   taskkill /F /IM prometheus.exe
   taskkill /F /IM thanos.exe
   ```
3. 如果端口被占用，可以使用 `netstat -ano | findstr :[端口号]` 检查
4. Sidecar 默认会使用 10901(gRPC) 和 10902(HTTP) 端口
5. Query 使用 10903(HTTP) 和 10911(gRPC) 端口，避免与 Sidecar 冲突



# consul配置

## 1. 创建 Prometheus 服务注册配置
创建文件 `prometheus-service.json`:
```json
{
  "Name": "prometheus",
  "ID": "prometheus-192.168.100.200-9090",
  "Address": "192.168.100.200",
  "Port": 9090,
  "Tags": [
    "app=20250512",
    "area=全国",
    "biz=基础环境智能监控平台prometheus",
    "cluster=北中心",
    "env=生产",
    "instance=192.168.100.200",
    "job=linux_prod",
    "replica=0",
    "support=v1",
    "tmp_hash=1"
  ],
  "Check": {
    "HTTP": "http://192.168.100.200:9090/-/healthy",
    "Interval": "10s"
  }
}
```

## 2. 创建 Windows Exporter 服务注册配置
创建文件 `windows-exporter-service.json`:
```json
{
  "Name": "windows-exporter",
  "ID": "windows-exporter-192.168.100.200-9182",
  "Address": "192.168.100.200",
  "Port": 9182,
  "Tags": [
    "app=None",
    "area=全国",
    "biz=基础环境智能监控平台windows",
    "cluster=北中心",
    "env=生产",
    "instance=192.168.100.200",
    "job=linux_prod",
    "replica=0",
    "support=v1",
    "tmp_hash=1"
  ],
  "Check": {
    "HTTP": "http://192.168.100.200:9182/metrics",
    "Interval": "10s"
  }
}
```

## 3. 注册服务到 Consul
```bash
# 注册 Prometheus 服务
curl -X PUT --data '{
  "Name": "prometheus",
  "ID": "prometheus-192.168.100.200-9090",
  "Address": "192.168.100.200",
  "Port": 9090,
  "Tags": [
    "app=20250512",
    "area=全国",
    "biz=基础环境智能监控平台prometheus",
    "cluster=北中心",
    "env=生产",
    "instance=192.168.100.200",
    "job=linux_prod",
    "replica=0",
    "support=v1",
    "tmp_hash=1"
  ],
  "Check": {
    "HTTP": "http://192.168.100.200:9090/-/healthy",
    "Interval": "10s"
  }
}' http://localhost:8500/v1/agent/service/register

# 注册 Windows Exporter 服务
curl -X PUT --data '{
  "Name": "windows-exporter",
  "ID": "windows-exporter-192.168.100.200-9182",
  "Address": "192.168.100.200",
  "Port": 9182,
  "Tags": [
    "app=None",
    "area=全国",
    "biz=基础环境智能监控平台windows",
    "cluster=北中心",
    "env=生产",
    "instance=192.168.100.200",
    "job=linux_prod",
    "replica=0",
    "support=v1",
    "tmp_hash=1"
  ],
  "Check": {
    "HTTP": "http://192.168.100.200:9182/metrics",
    "Interval": "10s"
  }
}' http://localhost:8500/v1/agent/service/register
```

# 注册linux_prod 写入consul

```
curl -X PUT --data "{\"Name\":\"windows-exporter\",\"ID\":\"windows-exporter-192.168.100.200-9182\",\"Address\":\"192.168.100.200\",\"Port\":9182,\"Tags\":[\"app=None\",\"area=全国\",\"biz=基础环境智能监控平台windows\",\"cluster=北中心\",\"env=生产\",\"instance=192.168.100.200\",\"job=linux_prod\",\"replica=0\",\"support=v1\",\"tmp_hash=1\"],\"Check\":{\"HTTP\":\"http://192.168.100.200:9182/metrics\",\"Interval\":\"10s\"}}" http://192.168.100.100:8500/v1/agent/service/register
```
## 4. 验证服务注册状态
```bash
# 查看所有注册的服务
curl http://localhost:8500/v1/agent/services

# 如需取消注册服务
curl -X PUT http://localhost:8500/v1/agent/service/deregister/prometheus-192.168.100.200-9090
curl -X PUT http://localhost:8500/v1/agent/service/deregister/windows-exporter-192.168.100.200-9182
```

## 5. 服务注册说明
- 每个服务都包含基本信息（Name、ID、Address、Port）
- Tags 包含所有需要被 Prometheus 采集的标签
- Check 配置用于健康检查，确保服务可用性
- 服务注册后可以通过 Consul UI (http://localhost:8500) 查看状态

