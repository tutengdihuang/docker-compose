version: '3.8'
services:
  clickhouse:
    image: yandex/clickhouse-server:22.3.13
    container_name: clickhouse
    restart: unless-stopped
    environment:
      TZ: Asia/Shanghai
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: clickhouse123
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
      MAX_MEMORY_USAGE: 8589934592
      MAX_MEMORY_USAGE_FOR_USER: 8589934592
      MAX_CONCURRENT_QUERIES: 100
      MAX_CONCURRENT_QUERIES_FOR_USER: 100
      MAX_SERVER_MEMORY_USAGE: 0
      MAX_SERVER_MEMORY_USAGE_TO_RAM_RATIO: 0.9
      FORMAT_SCHEMA_PATH: /var/lib/clickhouse/format_schemas/
    volumes:
      - ./data:/var/lib/clickhouse
      - ./logs:/var/log/clickhouse-server
      - ./config:/etc/clickhouse-server
      - /etc/localtime:/etc/localtime:ro
    ports:
      - 8123:8123 # HTTP接口
      - 9000:9000 # 原生客户端接口
      - 9009:9009 # 集群内部通信端口
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
      nproc:
        soft: 131072
        hard: 131072
    user: "101:101"
    healthcheck:
      test: wget --no-verbose --tries=1 --spider http://localhost:8123/ping || exit 1
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
    logging:
      driver: "json-file"
      options:
        max-size: "500m"
        max-file: "5"
    cap_add:
      - SYS_NICE
      - NET_ADMIN
      - IPC_LOCK
